<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des Offres d'Enseignement</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/offres.css">
</head>

<body>

  <%- include('partials/navbar-prof') %>


  <!-- Contenu principal : offres et carte -->
  <div class="content">
    <!-- Section des offres d'enseignement -->
    <div class="offers">
      <div class="background-blur"></div> <!-- Élément de fond séparé -->
      <% offres.forEach(offer => { %>
        <div class="offer">
          <h3>Mission à <%= offer.ville %></h3>
          <p><strong>Nombre d'heures :</strong> <%= offer.nbHeures %> heures</p>
          <p><strong>Date de début :</strong> <%= offer.startDate %></p>
          <p><strong>Date de fin :</strong> <%= offer.endDate %></p>
          <p><strong>Ville :</strong> <%= offer.ville %></p>
          <button class="accept-btn" data-id = "<%=offer.id %>">Accepter</button>
        </div>
      <% }) %>
    </div>

    <!-- Section de la carte Google Maps -->
    <div id="map"></div>
  </div>

  <!-- Intégration de Google Maps -->
  <script>
    const offres = <%- JSON.stringify(offres) %>;
    function initMap() {
      const franceCenter = { lat: 46.603354, lng: 1.888334 };
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: franceCenter
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            new google.maps.Marker({
              position: userLocation,
              map: map,
              icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
              title: "Votre position"
            });

            map.setCenter(userLocation);
          },
          () => {
            alert("Géolocalisation non autorisée.");
          }
        );
      } else {
        alert("Géolocalisation non supportée par le navigateur.");
      }

      offres.forEach((offre) => {
        new google.maps.Marker({
          position: { lat: offre.latitude, lng: offre.longitude },
          map: map,
          title: offre.ville,
        });
      });
    }
  </script>
  <script async defer
    src='https://maps.googleapis.com/maps/api/js?key=AIzaSyDgOz2GSk6BRSl8UQWGqnLUNSiEkZoBJZ8&callback=initMap'>
  </script>

  <script>
    document.querySelectorAll('.accept-btn').forEach(button => {
      button.addEventListener('click', function () {
        const offreID = this.dataset.id;
        fetch('/offres/accept', {
          method : 'POST',
          headers: {
            'Content-Type' : 'application/json'
          },
          body: JSON.stringify({ id: offreID})
        })
        .then(response => {
          if (response.ok) {
            this.textContent = 'Accepté';
            this.classList.add('accepted'); // Optionnel : ajouter une classe pour modifier le style si souhaité
            this.disabled = true; // Désactive le bouton après acceptation
          } else {
            alert('Erreur lors de la mise à jour');
          }
        })
        .catch(err => {
          console.error(err);
          alert('Erreur réseau');
        });        
      });
    });
  </script>
</body>

</html>